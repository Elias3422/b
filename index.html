<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>M3U Scanner ‚Äî Frontend</title>
<style>
  :root{
    --bg:#0b1220; --panel:#071625; --muted:#9fb3bf; --accent:#0ea5a4; --card:#06121a;
  }
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,monospace;background:var(--bg);color:#e6eef8;margin:0;padding:20px}
  .wrap{max-width:980px;margin:0 auto}
  header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  h1{margin:0;font-size:1.2rem}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  input[type=text]{flex:1;padding:10px;border-radius:8px;border:1px solid #123;background:#03121a;color:#e6eef8}
  select,button{padding:10px;border-radius:8px;border:0;background:var(--accent);color:#021014;cursor:pointer}
  button.secondary{background:#64748b;color:#e6eef8}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
  .status{font-size:0.95rem;color:var(--muted);margin-bottom:8px}
  .outwrap{display:flex;gap:12px;margin-top:12px;flex-direction:column}
  .output{background:#03121a;padding:12px;border-radius:8px;min-height:160px;overflow:auto;color:#cfe}
  .output pre{white-space:pre-wrap;font-family:monospace;margin:0}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .small{font-size:0.85rem;color:var(--muted)}
  .actions{display:flex;gap:8px;margin-top:8px}
  .link{color:var(--accent);text-decoration:none}
  .iframe-wrap{width:100%;min-height:420px;background:#071018;border-radius:8px;overflow:auto}
  @media (max-width:600px){ input[type=text]{width:100%} .header-right{display:none} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üîç M3U Scanner</h1>
      <div class="header-right small" style="margin-left:auto;color:var(--muted)">Worker frontend</div>
    </header>

    <div class="card">
      <div class="controls">
        <input id="url" type="text" placeholder="M3U URL (z. B. http://host:8080/get.php?username=...&password=...)">
        <select id="format" title="Ausgabeformat">
          <option value="html">HTML (Dashboard)</option>
          <option value="text">Plain Text (VŒûNGŒûANCŒû)</option>
          <option value="json">JSON (raw)</option>
        </select>
        <button id="scan">Scan</button>
        <button id="openNew" class="secondary" title="√ñffnet Ergebnis in neuem Tab">Open</button>
      </div>

      <div class="status small" id="status">Trage eine URL ein und klicke ‚ÄπScan‚Ä∫. Achte auf encodeURIComponent beim Kopieren langer URLs.</div>

      <div class="outwrap">
        <!-- HTML output will be injected into this container if format=html -->
        <div id="htmlContainer" class="iframe-wrap" style="display:none"></div>

        <!-- Text/JSON output -->
        <div id="textContainer" class="output" style="display:none">
          <pre id="output"></pre>
        </div>

        <div class="actions">
          <button id="copy" class="secondary">Kopieren</button>
          <button id="download" class="secondary">Herunterladen</button>
          <a id="openRaw" class="link" href="#" target="_blank" rel="noopener noreferrer" style="display:none">Direkt √∂ffnen</a>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // Set your worker URL here:
  const WORKER_URL = "https://m3usort.elias256.workers.dev"; // <- ERSETZEN
  const urlEl = document.getElementById('url');
  const outEl = document.getElementById('output');
  const htmlContainer = document.getElementById('htmlContainer');
  const textContainer = document.getElementById('textContainer');
  const statusEl = document.getElementById('status');
  const formatEl = document.getElementById('format');
  const openNewBtn = document.getElementById('openNew');
  const copyBtn = document.getElementById('copy');
  const downloadBtn = document.getElementById('download');
  const openRaw = document.getElementById('openRaw');

  // load last used URL
  try { const last = localStorage.getItem('m3u_last_url'); if (last) urlEl.value = last; } catch(e){}

  function setStatus(s, isError=false){
    statusEl.textContent = s;
    statusEl.style.color = isError ? '#ff7b7b' : '';
  }

  function buildWorkerFetchUrl(target, format){
    return `${WORKER_URL}?url=${encodeURIComponent(target)}&format=${encodeURIComponent(format)}`;
  }

  async function scan(){
    const url = urlEl.value.trim();
    if (!url) { alert('Bitte eine URL eingeben!'); return; }
    // save
    try { localStorage.setItem('m3u_last_url', url); } catch(e){}
    const fmt = formatEl.value;
    const workerFetch = buildWorkerFetchUrl(url, fmt);
    setStatus('‚è≥ Scanne ‚Äî warte auf Antwort von Worker ...');

    // Reset UI
    htmlContainer.style.display = 'none';
    textContainer.style.display = 'none';
    outEl.textContent = '';
    openRaw.style.display = 'none';
    openRaw.href = '#';

    try {
      const res = await fetch(workerFetch, { method: 'GET', credentials: 'omit' });
      if (!res.ok) {
        // try to parse body for helpful message
        let txt = await res.text().catch(()=>String(res.status));
        setStatus(`‚ùå Fehler: ${res.status} ‚Äî ${txt}`, true);
        return;
      }

      if (fmt === 'html') {
        // insert HTML response into container (safe because worker produces inert UI)
        const html = await res.text();
        htmlContainer.innerHTML = html;
        htmlContainer.style.display = 'block';
        setStatus('‚úÖ Fertig ‚Äî Dashboard gerendert');
        // provide raw open link
        openRaw.href = buildWorkerFetchUrl(url, 'html');
        openRaw.style.display = 'inline';
      } else if (fmt === 'text') {
        const txt = await res.text();
        outEl.textContent = txt;
        textContainer.style.display = 'block';
        setStatus('‚úÖ Fertig ‚Äî Textausgabe');
        openRaw.href = buildWorkerFetchUrl(url, 'text');
        openRaw.style.display = 'inline';
      } else { // json
        const j = await res.json();
        outEl.textContent = JSON.stringify(j, null, 2);
        textContainer.style.display = 'block';
        setStatus('‚úÖ Fertig ‚Äî JSON erhalten');
        openRaw.href = buildWorkerFetchUrl(url, 'json');
        openRaw.style.display = 'inline';
      }
    } catch (err) {
      setStatus('‚ùå Fehler: ' + (err.message || err), true);
    }
  }

  document.getElementById('scan').addEventListener('click', scan);
  formatEl.addEventListener('change', ()=>{ outEl.textContent=''; htmlContainer.style.display='none'; textContainer.style.display='none'; openRaw.style.display='none'; });

  // open in new tab (worker raw url)
  openNewBtn.addEventListener('click', ()=>{
    const url = urlEl.value.trim();
    if (!url) return alert('Bitte eine URL eingeben!');
    window.open(buildWorkerFetchUrl(url, formatEl.value), '_blank', 'noopener');
  });

  copyBtn.addEventListener('click', async ()=>{
    const fmt = formatEl.value;
    let text = '';
    if (fmt === 'html') text = htmlContainer.innerHTML || '';
    else text = outEl.textContent || '';
    if (!text) return alert('Keine Ausgabe zum Kopieren vorhanden.');
    try {
      await navigator.clipboard.writeText(text);
      setStatus('‚úÖ In die Zwischenablage kopiert');
    } catch (e) {
      setStatus('‚ùå Kopieren fehlgeschlagen: ' + (e.message||e), true);
    }
  });

  downloadBtn.addEventListener('click', ()=>{
    const fmt = formatEl.value;
    let content = '';
    let ext = 'txt';
    if (fmt === 'html') { content = htmlContainer.innerHTML || ''; ext = 'html' }
    else if (fmt === 'json') { content = outEl.textContent || ''; ext = 'json' }
    else { content = outEl.textContent || ''; ext = 'txt' }

    if (!content) return alert('Keine Ausgabe zum Herunterladen vorhanden.');
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `m3u_scan_result.${ext}`;
    a.click();
    setStatus('‚úîÔ∏è Download gestartet');
  });

  // allow Enter key to trigger scan
  urlEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ scan(); } });
})();
</script>
</body>
</html>
